- name: etcd3.service
  command: start
  content: |
    [Unit]
    Description=etcd3
{% if item.ssl == true %}
    After=kraken-etcd-ssl.service
    Requires=kraken-etcd-ssl.service
{% else %}
    After=setup-network-environment.service
    Requires=setup-network-environment.service
{% endif %}
{% for mount in item.nodepool.mounts %}
    After={{mount.device | mapdevice}}.mount
{% endfor %}
    Requires=setup-network-environment.service
    After=setup-network-environment.service
    [Service]
    EnvironmentFile=/etc/network-environment
    TimeoutStartSec=0
    KillMode=none
    ExecStartPre=-/usr/bin/docker kill etcd_{{item.name}}
    ExecStartPre=-/usr/bin/docker rm etcd_{{item.name}}
    ExecStartPre=/usr/bin/mkdir -p /var/lib/etcd/ephemeral
    ExecStart=/usr/bin/docker run -v /var/lib/etcd/ephemeral:/ephemeral {% if item.ssl == true %}-v /opt/kraken:/etc{% endif %} \ 
        {% for port in item.clientPorts %}-p {{port}}:{{port}} {% endfor %}{% for port in item.peerPorts %}-p {{port}}:{{port}} {% endfor %} \
        --name etcd_{{item.name}} quay.io/coreos/etcd:{{item.version}} \
        --data-dir /ephemeral
        --name etcd3 \
{% if item.ssl == true %}
        --peer-client-cert-auth \
        --peer-trusted-ca-file=/etc/ca.pem \
        --peer-cert-file=/etc/etcd/ssl/server.pem \
        --peer-key-file=/etc/etcd/ssl/server-key.pem \
{% endif %}
        --discovery-srv {{item.name}}.{{kraken_config.cluster}}.internal \
        --initial-advertise-peer-urls {% if item.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:2382 \
        --initial-cluster-token {{item.clusterToken}} \
        --initial-cluster-state new \
        --advertise-client-urls {% if item.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:2381 \
        --listen-client-urls {% if item.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:2381 \
        --listen-peer-urls {% if item.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:2382
    ExecStartStop=/usr/bin/docker stop etcd_{{item.name}}