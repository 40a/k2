{% for mount in item.nodepool.mounts %}
- name: format-storage-{{mount.device | mapdevice}}.service
  command: start
  content: |
    [Unit]
    Description=Formats {{mount.device | mapdevice}} drive as ext4 {% if mount.forceFormat == false %}if not already formatted{% endif %}
    After=dev-{{mount.device}}.device
    Requires=dev-{{mount.device}}.device
    [Service]
    Type=oneshot
    RemainAfterExit=yes
    {% if mount.forceFormat == true %}
    ExecStartPre=/usr/sbin/wipefs -f {{mount.device | mapdevice}}
    ExecStart=/usr/sbin/mkfs.ext4 -F {{mount.device | mapdevice}}
    {% else %}
    ExecStart=/bin/bash -c '(/usr/sbin/blkid -t TYPE=ext4 | /usr/bin/grep {{mount.device | mapdevice}}) || (/usr/sbin/wipefs -fa {{mount.device | mapdevice}} && /usr/sbin/mkfs.ext4 {{mount.device | mapdevice}})'
    {% endif %}
{% endfor %}