[Unit]
Description=Launch hyperkube node
EnvironmentFile=/etc/network-environment
Requires=network-online.target
After=network-online.target

[Service]
Restart=always
ExecStartPre=-/usr/bin/docker kill kube-node
ExecStartPre=-/usr/bin/docker rm kube-node
ExecStart=/usr/bin/docker run \
  --name kube-node \
  --net=host \
  --privileged \
  -v /var/run/docker.sock:/var/run/docker.sock \
  {{hyperkube_image}} \
    /hyperkube kubelet \
    --address=0.0.0.0 \
    --api_servers=http://{{master_private_ip}}:8080 \
    --cadvisor_port=4194 \
    --cluster_dns={{dns_ip}} \
    --cluster_domain={{dns_domain}} \
    --enable_server \
    --healthz_bind_address=0.0.0.0 \
    --healthz_port=10254 \
    --hostname_override={{ansible_local.kubernetes_node_ip_fact.node_ip_address}} \
    --logtostderr=true \
    --port=10250 \
    --read_only_port=10255 \
    --v={{kubernetes_verbosity}}
