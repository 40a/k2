---
# Common tasks for every node
- include: common.yaml

- include: sysdig-cloud-agent.yaml

- include: cadvisor.yaml
  when: "'master' in group_names or 'etcd' in group_names or 'apiservers' in group_names"

- include: kubectl.yaml
  when: "'master' in group_names or 'apiservers' in group_names or 'nodes' in group_names"

# Kubernetes master specific tasks
- stat: path={{ kubernetes_cert_dir }}/secured
  register: run_cert_generation
  when: "'master' in group_names"

- include: generate-kube-auth.yaml
  when: "'master' in group_names and run_cert_generation.stat.exists == False"
- include: generate-kube-cert.yaml
  when: "'master' in group_names and run_cert_generation.stat.exists == False"
- include: create-kubectl-config.yaml
  when: "'master' in group_names and run_cert_generation.stat.exists == False"
- include: nginx-proxy.yaml
  when: "'master' in group_names"
- include: master-binary.yaml
  when: "'master' in group_names and hyperkube_deployment_mode == 'binary'"
- include: master-docker.yaml
  when: "'master' in group_names and hyperkube_deployment_mode == 'docker'"
- include: kraken-services-setup.yaml
  when: "'master' in group_names"
- include: thirdparty-scheduler.yaml
  when: "'master' in group_names and thirdparty_scheduler|default('') != ''"
- include: kraken-services-run.yaml
  when: "'master' in group_names"

# Kubernetes apiserver specific tasks
- include: load-kube-cert.yaml
  when: "'apiservers' in group_names"
- include: load-kube-auth.yaml
  when: "'apiservers' in group_names"
- include: apiserver-binary.yaml
  when: "'apiservers' in group_names and hyperkube_deployment_mode == 'binary'"
- include: apiserver-docker.yaml
  when: "'apiservers' in group_names and hyperkube_deployment_mode == 'docker'"

# Kubernetes node and special node specific tasks
- include: node-pre.yaml
  when: "'nodes' in group_names"
- include: node-pre.yaml
  when: "'specialnodes' in group_names"
- include: create-kubectl-config.yaml
  when: "'nodes' in group_names"
- include: create-kubectl-config.yaml
  when: "'nodes' in group_names"
- include: create-kubectl-config.yaml
  when: "'specialnodes' in group_names"
- include: node-binary.yaml
  when: "'nodes' in group_names and hyperkube_deployment_mode == 'binary'"
- include: node-binary.yaml
  when: "'specialnodes' in group_names and hyperkube_deployment_mode == 'binary'"
- include: node-docker.yaml
  when: "'nodes' in group_names and hyperkube_deployment_mode == 'docker'"
- include: node-docker.yaml
  when: "'specialnodes' in group_names and hyperkube_deployment_mode == 'docker'"
- include: node-post.yaml
  when: "'nodes' in group_names"
- include: node-post.yaml
  when: "'specialnodes' in group_names"
