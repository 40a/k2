---

- name: Create /opt/bin/kraken-services for custom binaries
  become: yes
  file: >
    path=/opt/bin/kraken-services
    state=directory
    owner=core
    group=core

- name: Download kraken-services
  git: repo={{kraken_services_repo}}
       dest=/opt/bin/kraken-services
       version={{kraken_services_branch}}
       accept_hostkey=yes
       force=yes
  become: yes

- name: Create kraken-render script
  template: src=kraken-render.sh.ansible
            dest=/opt/bin/kraken-render.sh
  become: yes

- name: Make kraken render script executable
  become: yes
  file: path=/opt/bin/kraken-render.sh state=file mode="a+x"

- name: Run kraken render script
  become: yes
  shell: /opt/bin/kraken-render.sh
  register: render_result
  until: render_result.rc == 0
  retries: 100
  delay: 5
